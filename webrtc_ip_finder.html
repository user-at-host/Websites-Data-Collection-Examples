<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Hardware Information</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

    <style>
        .info-box {
            display: flex;
            justify-content: space-between;
            align-items: center;

            background-color: var(--pico-card-background-color);
            border: 1px solid var(--pico-muted-border-color);
            border-radius: var(--pico-border-radius);
            box-shadow: var(--pico-card-box-shadow);
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
        }

        .info-label {
            font-weight: bold;
            color: var(--pico-primary);
        }

        .info-value {
            font-family: var(--pico-font-family-monospace);
            background-color: var(--pico-muted-background-color);
            padding: 0.25rem 0.5rem;
            border-radius: var(--pico-border-radius);
        }
    </style>

</head>

    <body>

        <main class="container">
            <style>
                /* Basic styling to replace the <br> tag */
                #findIpBtn {
                    margin-bottom: 1.5rem;
                }
            </style>
            <article>
                <h1>WebRTC IP Address Finder</h1>
                
                <div class="note">
                    <p>This tool uses the WebRTC API to discover your public IP addresses. This demonstrates how websites can identify you even if you are using a VPN that doesn't protect against WebRTC leaks.</p>
                </div>

                <button id="findIpBtn">Find My IP Addresses</button>

                <h2>Discovered IP Addresses:</h2>
                <pre id="ipList">Click the button to start the search...</pre>

                <script>
                    const findIpBtn = document.getElementById('findIpBtn');
                    const ipList = document.getElementById('ipList');

                    findIpBtn.addEventListener('click', () => {
                        findIpBtn.disabled = true;
                        ipList.textContent = 'Searching for IP addresses...';
                        
                        if (!window.RTCPeerConnection) {
                            ipList.textContent = 'WebRTC is not supported by your browser.';
                            findIpBtn.disabled = false;
                            return;
                        }

                        const ipAddresses = new Set();
                        const pc = new RTCPeerConnection({
                            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                        });

                        // 1. COLLECT IPs EFFICIENTLY
                        // Listen for ICE candidates but DO NOT update the UI here.
                        pc.onicecandidate = (event) => {
                            if (!event || !event.candidate || !event.candidate.candidate) {
                                return;
                            }
                            
                            // 2. USE ROBUST PARSING
                            // The IP is the 5th field in the candidate string. Split and grab it.
                            const candidateFields = event.candidate.candidate.split(' ');
                            const ip = candidateFields[4];

                            // Ensure we have a valid IP and it's not a multicast address
                            if (ip && ip.indexOf('.') > -1 || ip.indexOf(':') > -1) {
                                // Some STUN servers return mDNS addresses. Filter them out.
                                if (!ip.endsWith('.local')) {
                                    ipAddresses.add(ip);
                                }
                            }
                        };
                        
                        // 3. CENTRALIZE FINALIZATION LOGIC
                        // Use 'icegatheringstatechange' as the single source of truth for completion.
                        pc.onicegatheringstatechange = () => {
                            if (pc.iceGatheringState === 'complete') {
                                findIpBtn.disabled = false;
                                
                                // 4. UPDATE UI ONCE
                                // Now that we have all IPs, update the list.
                                if (ipAddresses.size > 0) {
                                    updateIpList(ipAddresses);
                                } else {
                                    ipList.textContent = 'No IP addresses found. Your browser might be blocking WebRTC requests.';
                                }
                            }
                        };

                        // Trigger the ICE gathering process
                        pc.createDataChannel('');
                        pc.createOffer()
                            .then(offer => pc.setLocalDescription(offer))
                            .catch(err => {
                                console.error("Error creating offer:", err);
                                ipList.textContent = `Error: ${err.toString()}`;
                                findIpBtn.disabled = false;
                            });
                    });

                    function updateIpList(ipSet) {
                        let output = '';
                        ipSet.forEach(ip => {
                            const type = isPrivateIP(ip) ? 'Local (Private) IP:' : 'Public IP:';
                            output += `${type.padEnd(20)} ${ip}\n`;
                        });
                        ipList.textContent = output.trim();
                    }

                    // Checks for both IPv4 and IPv6 private/local ranges
                    function isPrivateIP(ip) {
                        if (ip.includes(':')) { // IPv6
                            // Check for Loopback, Unique Local, and Link-Local addresses
                            return /^(::1|fc00:|fe80:)/i.test(ip);
                        }
                        // IPv4
                        const parts = ip.split('.').map(Number);
                        return parts[0] === 10 ||
                            (parts[0] === 172 && parts[1] >= 16 && parts[1] <= 31) ||
                            (parts[0] === 192 && parts[1] === 168) ||
                            (parts[0] === 127); // Added loopback check for completeness
                    }
                </script>
            </article>
        </main>

    </body>
</html>
